<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viegas - Dashboard de Monitoramento Híbrido</title>

    <!-- Frameworks e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background: #020617; 
            color: #f8fafc; 
            font-family: 'Rajdhani', sans-serif; 
            overflow-x: hidden;
        }
        
        /* Efeito de Vidro (Glassmorphism) */
        .glass { 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.05); 
        }

        /* Animação de Alerta Crítico */
        .offline-blink { 
            animation: blink 0.8s infinite; 
            background: #ef4444 !important; 
            box-shadow: 0 0 20px #ef4444;
        }
        @keyframes blink { 
            50% { opacity: 0.6; } 
        }

        /* Estilização do Mapa para Dark Mode */
        #map { 
            height: 300px; 
            border-radius: 24px; 
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }

        .card-title {
            letter-spacing: 0.15em;
            font-weight: 700;
        }
    </style>
</head>

<body class="flex h-screen">

    <!-- Sidebar Lateral -->
    <aside class="w-72 glass border-r border-white/5 p-6 flex flex-col justify-between hidden md:flex">
        <div>
            <!-- Marca Viegas -->
            <div class="mb-10">
                <img src="/static/img/logo-viegas.png" alt="Viegas Soluções" class="w-full h-auto drop-shadow-2xl">
                <div class="mt-6 h-px bg-gradient-to-r from-emerald-500/40 to-transparent"></div>
            </div>

            <!-- Navegação -->
            <nav class="space-y-3">
                <div class="flex items-center gap-3 p-4 bg-emerald-500/10 text-emerald-400 rounded-2xl border-l-4 border-emerald-500 shadow-lg shadow-emerald-500/5">
                    <i class="fas fa-satellite-dish"></i>
                    <span class="font-bold uppercase text-sm tracking-widest">Nós Ativos</span>
                </div>
                <div class="flex items-center gap-3 p-4 text-slate-500 hover:text-slate-300 transition cursor-not-allowed">
                    <i class="fas fa-brain"></i>
                    <span class="font-bold uppercase text-sm tracking-widest">IA Predição</span>
                </div>
            </nav>
        </div>

        <!-- Info de Sistema e Logout -->
        <div class="space-y-6">
            <div class="p-4 glass rounded-2xl">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Status de Borda</p>
                <p class="text-xs text-emerald-400 font-bold">MikroTik CHR v7.20</p>
            </div>
            <a href="/logout" class="flex items-center gap-2 text-slate-500 hover:text-red-400 text-xs font-bold uppercase tracking-[0.2em] transition group">
                <i class="fas fa-power-off group-hover:animate-pulse"></i> Sair do Sistema
            </a>
        </div>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="flex-1 p-6 md:p-10 overflow-y-auto">

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h2 class="text-4xl font-bold uppercase tracking-tighter text-white">Gestão de Riscos <span class="text-emerald-500 italic">Ambientais</span></h2>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">Monitoramento em tempo real - Camada Híbrida</p>
            </div>

            <div id="status-card" class="bg-slate-800/80 px-8 py-3 rounded-full border border-slate-700 flex items-center space-x-3 transition-all duration-500">
                <div id="dot" class="w-2.5 h-2.5 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]"></div>
                <span id="status-text" class="text-xs font-black uppercase tracking-[0.2em] text-emerald-400">Gateway Sincronizado</span>
            </div>
        </header>

        <!-- Grade de Cards em Tempo Real -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">

            <!-- Card RAK (Campo Real) -->
            <div class="glass p-8 rounded-[2.5rem] border-t-4 border-sky-500 shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition"><i class="fas fa-biohazard text-6xl"></i></div>
                <p class="card-title text-[10px] text-slate-500 uppercase mb-4">Nó Campo A (RAK12004)</p>
                <div class="flex items-baseline gap-2">
                    <span id="rak-h2s" class="text-7xl font-bold tracking-tighter">0.0</span>
                    <span class="text-slate-500 text-xl font-bold uppercase">ppm</span>
                </div>
                <div class="mt-4 flex items-center gap-2 text-xs text-sky-400 font-bold">
                    <i class="fas fa-thermometer-half"></i> <span id="rak-temp">0</span>°C
                </div>
            </div>

            <!-- Card NIT (Campo Real) -->
            <div class="glass p-8 rounded-[2.5rem] border-t-4 border-emerald-500 shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition"><i class="fas fa-tint text-6xl"></i></div>
                <p class="card-title text-[10px] text-slate-500 uppercase mb-4">Nó Campo B (NIT21L)</p>
                <div class="flex items-baseline gap-2 text-emerald-400">
                    <span id="nit-umid" class="text-7xl font-bold tracking-tighter">0.0</span>
                    <span class="text-emerald-600/50 text-xl font-bold uppercase">%</span>
                </div>
                <div class="mt-4 flex items-center gap-2 text-xs text-emerald-500 font-bold">
                    <i class="fas fa-thermometer-half"></i> <span id="nit-temp">0</span>°C
                </div>
            </div>

            <!-- Card Auditoria (Pentest / Borda) -->
            <div id="sim-card" class="glass p-8 rounded-[2.5rem] border-t-4 border-purple-500 shadow-xl transition-all duration-500">
                <div class="flex justify-between items-start mb-4">
                    <p class="card-title text-[10px] text-slate-500 uppercase tracking-widest">Auditoria de Borda (MikroTik)</p>
                    <span id="sim-risco" class="text-[9px] font-black px-3 py-1 bg-emerald-500 text-white rounded-full uppercase">Estável</span>
                </div>
                <div class="text-7xl font-bold tracking-tighter text-white" id="sim-h2s">0.0</div>
                <div class="mt-4 text-[10px] text-slate-500 font-bold uppercase flex justify-between italic">
                    <span>Sync: <span id="sim-time">--:--:--</span></span>
                    <span class="text-purple-400">Lab Experimental</span>
                </div>
            </div>

        </div>

        <!-- Seção de Tabelas de Histórico -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
            
            <!-- Histórico RAK -->
            <div class="glass p-6 rounded-[2rem]">
                <h3 class="text-xs font-bold uppercase tracking-widest text-sky-400 mb-4 flex items-center gap-2">
                    <i class="fas fa-list-ul"></i> Log Telemetria RAK
                </h3>
                <table class="w-full text-xs text-left">
                    <thead class="text-slate-500 border-b border-white/5 uppercase text-[10px]">
                        <tr><th class="pb-3">Timestamp</th><th class="pb-3 text-right">Valor PPM</th></tr>
                    </thead>
                    <tbody id="table-rak" class="text-slate-400">
                        <!-- Gerado via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Histórico NIT -->
            <div class="glass p-6 rounded-[2rem]">
                <h3 class="text-xs font-bold uppercase tracking-widest text-emerald-400 mb-4 flex items-center gap-2">
                    <i class="fas fa-list-ul"></i> Log Telemetria NIT
                </h3>
                <table class="w-full text-xs text-left">
                    <thead class="text-slate-500 border-b border-white/5 uppercase text-[10px]">
                        <tr><th class="pb-3">Timestamp</th><th class="pb-3 text-right">Umidade %</th></tr>
                    </thead>
                    <tbody id="table-nit" class="text-slate-400">
                        <!-- Gerado via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Histórico Auditoria (Fundamental para o TCC) -->
            <div class="glass p-6 rounded-[2rem]">
                <h3 class="text-xs font-bold uppercase tracking-widest text-purple-400 mb-4 flex items-center gap-2">
                    <i class="fas fa-user-shield"></i> Registro de Injeção de Borda
                </h3>
                <table class="w-full text-xs text-left">
                    <thead class="text-slate-500 border-b border-white/5 uppercase text-[10px]">
                        <tr><th class="pb-3">Hora</th><th class="pb-3">ppm</th><th class="pb-3 text-right">Status</th></tr>
                    </thead>
                    <tbody id="table-sim" class="text-slate-400">
                        <!-- Gerado via JS -->
                    </tbody>
                </table>
            </div>

        </div>

        <!-- Seção Mapa e Análise -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass p-5 rounded-[2.5rem]">
                <div id="map"></div>
            </div>

            <div class="glass p-10 rounded-[2.5rem] flex flex-col justify-center border-r-4 border-emerald-500/20">
                <h3 class="text-xl font-bold text-white mb-4 uppercase tracking-tighter">Análise de Redes Distribuídas</h3>
                <div class="space-y-4 text-slate-400 text-sm leading-relaxed italic">
                    <p>
                        "A arquitetura proposta integra dispositivos LoRaWAN via Tago.io Cloud, utilizando um nó MikroTik CHR como Gateway de Borda. Este ambiente permite auditar a integridade dos dados e identificar vulnerabilidades de transporte (HTTP vs HTTPS)."
                    </p>
                    <p class="text-xs font-bold text-emerald-500/60 not-italic uppercase tracking-widest">
                        Localização Geográfica: Salvador, Bahia - Brasil
                    </p>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-slate-600 text-[10px] font-bold uppercase tracking-[0.5em] pb-10">
            Viegas Soluções Inovadoras &copy; 2026 | Especialização em Redes e Computação Distribuída
        </footer>

    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Inicialização do Mapa Leaflet
        var map = L.map('map', { zoomControl: false }).setView([-12.9704, -38.5067], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        var customIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#10b981; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 15px #10b981;'></div>",
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });

        L.marker([-12.9704, -38.5067], { icon: customIcon }).addTo(map)
            .bindPopup("<b style='color:#020617'>Campo de Sensores Bahia</b><br>RAK12004 & NIT21L");

        // Função de Atualização via AJAX
        async function updateDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Atualizar Cards RAK
                document.getElementById('rak-h2s').innerText = data.rak.h2s.toFixed(2);
                document.getElementById('rak-temp').innerText = data.rak.temp.toFixed(1);

                // Atualizar Cards NIT
                document.getElementById('nit-umid').innerText = data.nit.umid.toFixed(1);
                document.getElementById('nit-temp').innerText = data.nit.temp.toFixed(1);

                // Atualizar Cards Auditoria
                document.getElementById('sim-h2s').innerText = data.sim.h2s.toFixed(2);
                document.getElementById('sim-time').innerText = data.sim.time_str;
                
                const simRisco = document.getElementById('sim-risco');
                const simCard = document.getElementById('sim-card');
                simRisco.innerText = data.sim.risco;

                // Lógica de Cores para o Alerta de Auditoria
                if(data.sim.risco === "CRÍTICO") {
                    simRisco.className = "text-[9px] font-black px-3 py-1 bg-red-600 text-white rounded-full uppercase animate-pulse";
                    simCard.classList.add('border-red-500', 'shadow-red-500/20');
                } else {
                    simRisco.className = "text-[9px] font-black px-3 py-1 bg-emerald-500 text-white rounded-full uppercase";
                    simCard.classList.remove('border-red-500', 'shadow-red-500/20');
                }

                // Renderizar Tabelas (Últimos 5-10 registros)
                renderTable('table-rak', data.rak.history, 'val', 'sky');
                renderTable('table-nit', data.nit.history, 'val', 'emerald');
                renderTableSim('table-sim', data.sim.history);

                // Alerta de Inatividade (Ataque DoS no MikroTik ou queda do ngrok)
                const now = Date.now() / 1000;
                const delay = now - data.sim.ts;
                if (data.sim.ts > 0 && delay > 45) {
                    document.getElementById('status-card').className = "offline-blink px-8 py-3 rounded-full flex items-center space-x-3 transition-all";
                    document.getElementById('status-text').innerText = "BORDA OFFLINE: POSSÍVEL ATAQUE";
                    document.getElementById('status-text').className = "text-xs font-black uppercase tracking-widest text-white";
                    document.getElementById('dot').className = "w-2.5 h-2.5 bg-white rounded-full";
                } else {
                    document.getElementById('status-card').className = "bg-slate-800/80 px-8 py-3 rounded-full border border-slate-700 flex items-center space-x-3";
                    document.getElementById('status-text').innerText = "Gateway Sincronizado";
                    document.getElementById('status-text').className = "text-xs font-bold uppercase tracking-widest text-emerald-400";
                    document.getElementById('dot').className = "w-2.5 h-2.5 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]";
                }

            } catch (error) {
                console.error("Erro na atualização:", error);
            }
        }

        function renderTable(id, history, key, color) {
            const tbody = document.getElementById(id);
            if (!history || history.length === 0) {
                tbody.innerHTML = "<tr><td colspan='2' class='py-4 text-center opacity-30 italic'>Aguardando dados...</td></tr>";
                return;
            }
            tbody.innerHTML = history.map(h => `
                <tr class="border-b border-white/5 hover:bg-white/5 transition">
                    <td class="py-2.5 font-mono text-[10px]">${h.time}</td>
                    <td class="py-2.5 text-right font-bold text-${color}-400">${h[key]}</td>
                </tr>
            `).join('');
        }

        function renderTableSim(id, history) {
            const tbody = document.getElementById(id);
            if (!history || history.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3' class='py-4 text-center opacity-30 italic'>Sem logs de auditoria...</td></tr>";
                return;
            }
            tbody.innerHTML = history.map(h => `
                <tr class="border-b border-white/5 hover:bg-white/5 transition">
                    <td class="py-2.5 font-mono text-[10px]">${h.time}</td>
                    <td class="py-2.5 font-bold text-white">${h.val}</td>
                    <td class="py-2.5 text-right font-black ${h.risco === 'CRÍTICO' ? 'text-red-400' : 'text-emerald-500'}">${h.risco}</td>
                </tr>
            `).join('');
        }

        // Intervalo de 3 segundos para atualização fluida
        setInterval(updateDashboard, 3000);
        updateDashboard(); // Chamada inicial
    </script>
</body>
</html>